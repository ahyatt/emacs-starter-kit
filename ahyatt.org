#+TITLE: Emacs Starter Kit
#+SEQ_TODO: PROPOSED TODO STARTED | DONE DEFERRED REJECTED
#+OPTIONS: H:2 num:nil toc:t
#+STARTUP: oddeven
* Who am I?
#+srcname: ahyatt-who
#+begin_src emacs-lisp 
  (setq wave-client-user "ahyatt")
#+end_src

* Coding
** My coding style
#+srcname: ahyatt-coding-style
#+begin_src emacs-lisp
  (setq-default show-trailing-whitespace t)
  (add-hook 'c-mode-hook 'highlight-80+-mode)
  (add-hook 'c++-mode-hook 'highlight-80+-mode)
#+end_src
** Indent after yank
#+srcname: ahyatt-coding-indent
#+begin_src emacs-lisp 
  (defadvice yank (after c-indent-after-yank activate)
    "Do an indent after a yank"
    (if c-buffer-is-cc-mode
        (let ((transient-mark-mode nil))
          (indent-region (region-beginning) (region-end) nil))))
#+end_src

* My org setup
This has been precisely fine-tuned for how I like to work with org.
*** Loading extras
I wrote org-screen, and I do use it occasionally.
#+srcname: ahyatt-org-requires
#+begin_src emacs-lisp 
  (require 'org-screen)
#+end_src
*** Clock setting
I like to time tasks, display the time in the modeline, and have diary
entries in the modeline.
#+srcname: ahyatt-org-clock
#+begin_src emacs-lisp 
  (setq org-clock-string-limit 50
        org-log-done t
        org-agenda-include-diary t
        org-deadline-warning-days 1
        org-clock-idle-time 10
        org-agenda-start-with-log-mode nil)
#+end_src
*** Workflow
#+srcname: ahyatt-org-workflow
#+begin_src emacs-lisp 
  (setq org-todo-keywords '((sequence "TODO(t)" "STARTED(s)"
                                      "WAITING(w@/!)" "|" "DONE(d)"
                                      "OBSOLETE(o)"))
        org-agenda-custom-commands
        '(("w" todo "WAITING" nil)
          ("n" tags-todo "+someday"
           ((org-show-hierarchy-above nil) (org-agenda-todo-ignore-with-date t)
            (org-agenda-tags-todo-honor-ignore-options t)))
          ("0" "Critical tasks" ((agenda "") (tags-todo "+p0")))
          ("l" "Agenda and live tasks" ((agenda "")
                                        (tags-todo "-someday"))))
        org-enforce-todo-dependencies t
        org-agenda-todo-ignore-scheduled t
        org-agenda-dim-blocked-tasks 'invisible
        org-agenda-tags-todo-honor-ignore-options t
        org-agenda-skip-deadline-if-done 't
        org-agenda-skip-scheduled-if-done 't)
#+end_src
*** Navigation
#+srcname: ahyatt-org-navigation
#+begin_src emacs-lisp 
  (setq org-use-speed-commands t
        org-refile-targets '((nil . (:maxlevel . 3)))
        org-link-frame-setup '((gnus . gnus)
                               (file . find-file-other-window))
        org-use-speed-commands t
        org-completion-use-ido t
        org-use-fast-todo-selection t)
  
  (defun ash-agenda ()
    (interactive)
    (let ((buf (get-buffer "*Org Agenda*")))
      (if buf
          (switch-to-buffer buf)
        (org-agenda-goto-today))
      (ash-jabber-colorize-tags)))
  
  (global-set-key [M-f11] 'ash-agenda)
  (global-set-key [print] 'ash-agenda)
#+end_src
*** Remember integration
#+srcname: ahyatt-org-remember
#+begin_src emacs-lisp
  (setq remember-annotation-functions '(org-remember-annotation)
        remember-handler-functions '(org-remember-handler)
        org-remember-templates
        '(("Note" ?n "* %a%?\n%u\n%i" "~/org/work.org" "Unfiled notes")
          ("Journal" ?j "* %T %?" "~/org/notes.org" date-tree)
          ("Child todo" ?c "* TODO %?\n%a" "~/org/work.org" "Inbox")
          ("Todo" ?t "* TODO %?\n%a" "~/org/work.org" "Inbox")
          ("Act on email" ?a "* TODO Process [%a]\n%!" "~/org/work.org" "Inbox"
           (mime-view-mode wl-summary-mode gnus-summary-mode gnus-article-mode))))
  (add-hook 'remember-mode-hook 'org-remember-apply-template)
  (define-key global-map [f12] 'org-remember)
#+end_src
*** Jabber integration
Some code to colorize tags that are jabber names based on
availability.
#+srcname: ahyatt-org-jabber
#+begin_src emacs-lisp 
  (defun ash-jabber-colorize-tags ()
    (let ((contact-hash (make-hash-table :test 'equal)))
      (dolist (jc jabber-connections)
        (dolist (contact (plist-get (fsm-get-state-data jc) :roster))
          (puthash (car (split-string (symbol-name contact) "@")) contact contact-hash)))
      (save-excursion
        (goto-char (point-min))
        (while (re-search-forward ":\\(\\w+\\):" nil t)
          (let ((tag (match-string-no-properties 1)))
            (when (and tag (gethash tag contact-hash))
              (let* ((js (jabber-jid-symbol (gethash tag contact-hash)))
                     (connected (get js 'connected))
                     (show (get js 'show)))
                (if connected
                    (let ((o (make-overlay (match-beginning 1) (- (point) 1))))
                      (overlay-put o 'face
                                   (cons 'foreground-color
                                         (cond ((equal "away" show)
                                                "orange")
                                               ((equal "dnd" show)
                                                "red")
                                               (t "green")))))))))
          (backward-char)))))
#+end_src
***** TODO Move this into work-specific org file, plus integrate italic
* Misc customization
#+srcname: ahyatt-misc
#+begin_src emacs-lisp
  (savehist-mode 1)
  (recentf-mode 1)
  ;; Recentf is useless without saving frequently
  (run-with-idle-timer 1 nil 'recentf-save-list)
  
  (setq ibuffer-saved-filter-groups
        (quote (("default"
                 ("dired" (mode . dired-mode))
                 ("java" (mode . java-mode))
                 ("shell" (mode . shell-mode))
                 ("eshell" (mode . eshell-mode))
                 ("lisp" (mode . emacs-lisp-mode))
                 ("erc" (mode . erc-mode))
                 ("org" (mode . org-mode))
                 ("git" (mode . git-status-mode))
                 ("c++" (or
                         (mode . cc-mode)
                         (mode . c++-mode)))
                 ("emacs" (or
                           (name . "^\\*scratch\\*$")
                           (name . "^\\*Messages\\*$")))
                 ("gnus" (or
                          (mode . message-mode)
                          (mode . bbdb-mode)
                          (mode . mail-mode)
                          (mode . gnus-group-mode)
                          (mode . gnus-summary-mode)
                          (mode . gnus-article-mode)
                          (name . "^\\.bbdb$")
                          (name . "^\\.newsrc-dribble"))))))
        ibuffer-sorting-mode 'recency)
  
  (add-hook 'ibuffer-mode-hook
            (lambda ()
              (ibuffer-switch-to-saved-filter-groups "default")))
  
  (add-hook 'dired-mode-hook
            '(lambda ()
               (define-key dired-mode-map "e" 'wdired-change-to-wdired-mode)))
  
  (display-time-mode)
  
  (define-key global-map "\C-x\C-j" 'dired-jump)
#+end_src
* Jabber customizations
I've stopped using Jabber, since it seems to slow down emacs,
sometimes dramatically.  Still, it's nice to have in case I need it
again.
#+srcname: ahyatt-jabber
#+begin_src emacs-lisp
  (add-to-list 'load-path
               (expand-file-name (concat elisp-source-dir "/emacs-jabber")))
  (require 'jabber-autoloads)
  
  ;; I don't like the jabber modeline having counts, it takes up too
  ;; much room.
  (defadvice jabber-mode-line-count-contacts (around ash-remove-jabber-counts
                                                     (&rest ignore))
    "Override for count contacts, to remove contacts from modeline"
    (setq ad-return-value ""))
  (ad-activate 'jabber-mode-line-count-contacts)
  (add-hook 'jabber-chat-mode-hook 'flyspell-mode)
  (jabber-autoaway-start)
  
  (setq jabber-alert-message-hooks '(jabber-message-echo jabber-message-scroll)
        jabber-alert-muc-hooks '(jabber-muc-scroll)
        jabber-alert-presence-hooks (quote (jabber-presence-update-roster))
        jabber-autoaway-method (quote jabber-current-idle-time)
        jabber-mode-line-mode t
        jabber-cvard-avatars-retrieve t)
#+end_src
* Various packages
#+srcname: ahyatt-smex
#+begin_src emacs-lisp
  (require 'smex)
  (add-hook 'after-init-hook 'smex-initialize)
  (global-set-key (kbd "M-x") 'smex)
  (global-set-key (kbd "M-X") 'smex-major-mode-commands)
  (global-set-key (kbd "C-c M-x") 'smex-update-and-run)
  ;; This is the old M-x.
  (global-set-key (kbd "C-c C-c M-x") 'execute-extended-command)
  
  ;; edit server, a Chrome extension
  (if (and (daemonp) (locate-library "edit-server"))
      (progn
        (require 'edit-server)
        (edit-server-start)))
#+end_src
* Keychord
#+srcname: ahyatt-keychord
#+begin_src emacs-lisp
  (require 'key-chord)
  (key-chord-mode 1)
  (key-chord-define-global "jk" 'dabbrev-expand)
  (key-chord-define-global "l;" 'magit-status)
  (key-chord-define-global "`1" 'yas/expand)
  (key-chord-define-global "-=" (lambda () (interactive) (switch-to-buffer "*compilation*")))
  
  (key-chord-define-global "xb" 'recentf-ido-find-file)
  (key-chord-define-global "xg" 'smex)
  (key-chord-define-global "XG" 'smex-major-mode-commands)
#+end_src
* Gnus
This is for gnus customization, not anything server-specific.
#+srcname: ahyatt-gnus
#+begin_src emacs-lisp
  (setq bbdb-always-add-addresses 'ash-add-addresses-p)
  (setq bbdb-complete-name-allow-cycling t)
  (setq bbdb-completion-display-record nil)
  (setq bbdb-silent-running t)
  (setq bbdb-use-pop-up nil)
  (setq bbdb/mail-auto-create-p 'bbdb-ignore-some-messages-hook)
  (setq bbdb/news-auto-create-p 'bbdb-ignore-some-messages-hook)
  
  (setq gnus-ignored-newsgroups "^$")
  (setq mm-text-html-renderer 'w3m-standalone)
  (setq mm-attachment-override-types '("image/.*"))
  ;; No HTML mail
  (setq mm-discouraged-alternatives '("text/html" "text/richtext"))
  (setq gnus-message-archive-group "Sent")
  
  (setq gnus-ignored-mime-types '("text/x-vcard"))
  (setq gnus-agent-queue-mail nil)
  (setq gnus-keep-same-level 't)
  
  (setq gnus-summary-ignore-duplicates t)
  
  (setq gnus-group-use-permanent-levels 't)
  (setq gnus-summary-line-format "%-10&user-date;%U%R%z%I%(%[%-23,23f%]%) %s\n")
  
  ;; From http://emacs.wordpress.com/2008/04/21/two-gnus-tricks/
  (setq gnus-user-date-format-alist
        '(((gnus-seconds-today) . "Today, %H:%M")
          ((+ 86400 (gnus-seconds-today)) . "Yesterday, %H:%M")
          (604800 . "%A %H:%M") ;;that's one week
          ((gnus-seconds-month) . "%A %d")
          ((gnus-seconds-year) . "%B %d")
          (t . "%B %d '%y"))) ;;this one is used when no other does match
  
  ;; From http://www.emacswiki.org/emacs/init-gnus.el
  (setq gnus-summary-line-format "%U%R%z%O %{%16&user-date;%}   %{%-20,20n%} %{%ua%} %B %(%I%-60,60s%)\n")
  (defun gnus-user-format-function-a (header) 
    (let ((myself (concat "<" user-mail-address ">"))
          (references (mail-header-references header))
          (message-id (mail-header-id header)))
      (if (or (and (stringp references)
                   (string-match myself references))
              (and (stringp message-id)
                   (string-match myself message-id)))
          "X" "│")))
  
  (setq gnus-summary-same-subject "")
  (setq gnus-sum-thread-tree-indent "    ")
  (setq gnus-sum-thread-tree-single-indent "◎ ")
  (setq gnus-sum-thread-tree-root "● ")
  (setq gnus-sum-thread-tree-false-root "☆")
  (setq gnus-sum-thread-tree-vertical "│")
  (setq gnus-sum-thread-tree-leaf-with-other "├─► ")
  (setq gnus-sum-thread-tree-single-leaf "╰─► ")
  
  (setq gnus-single-article-buffer nil)
#+end_src

* Terminal
#+srcname: ahyatt-terminal
#+begin_src emacs-lisp 
  (defun ash-term-hooks ()
    ;; dabbrev-expand in term
    (define-key term-raw-escape-map "/"
      (lambda ()
        (interactive)
        (let ((beg (point)))
          (dabbrev-expand nil)
          (kill-region beg (point)))
        (term-send-raw-string (substring-no-properties (current-kill 0)))))
    ;; yank in term (bound to C-c C-y)
    (define-key term-raw-escape-map "\C-y"
      (lambda ()
         (interactive)
         (term-send-raw-string (current-kill 0))))
    (setq term-default-bg-color (face-background 'default))
    (setq term-default-fg-color (face-foreground 'default)))
  (add-hook 'term-mode-hook 'ash-term-hooks)
#+end_src

* Speed tweeks
#+srcname: ahyatt-speed
#+begin_src emacs-lisp 
  (setq ido-enable-tramp-completion nil)
#+end_src
* ERC
I used ERC primarily with bitlbee
** Base setup 
#+srcname: ahyatt-erc
#+begin_src emacs-lisp 
  (setq erc-modules '(autoaway autojoin completion fill irccontrols log match menu move-to-prompt noncommands notify readonly ring scrolltobottom smiley stamp track)
        erc-hide-list (quote ("JOIN" "KICK" "NICK" "PART" "QUIT" "MODE"))
        erc-autoaway-mode t
        erc-notify-mode t
        erc-echo-notices-in-minibuffer-flag t
        erc-auto-query 'window-noselect
        erc-autoaway-idletimer 'emacs
        erc-user-full-name user-full-name
        erc-track-when-inactive 'nil
        erc-track-exclude-types '(("JOIN" "NICK" "PART" "QUIT" "MODE"
                                   "324" "329" "332" "333" "353" "477"))
        erc-track-exclude-server-buffer t
        erc-track-showcount t
        erc-track-shorten-names nil)
#+end_src
** Modeline fix
For some reason, erc decides to use arbitrary faces for the modeline,
when I think there should be just one modeline face.  This doesn't
actually fix this as much as it should.
*** TODO Create a complete modeline face solution
#+srcname: ahyatt-erc-modeline
#+begin_src emacs-lisp 
  (require 'erc-track)  ;; to load the default definitions
  
  (defface erc-modeline
    '((((class color)) (:foreground "ping"))
      (t (:italic t) (:bold t)))
    "Face used for the header of a wave."
    :group 'erc)
  
  
  (defun erc-track-find-face (faces)
    "Just return a reasonable face"
    'erc-modeline)
#+end_src
** Modeline fix
For some reason, erc decides to use arbitrary faces for the modeline,
when I think there should be just one modeline face.  This fixes that.

#+srcname: ahyatt-erc-modeline
#+begin_src emacs-lisp 
  (require 'erc-track)  ;; to load the default definitions
  
  (defface erc-modeline
    '((((class color)) (:foreground "ping"))
      (t (:italic t) (:bold t)))
    "Face used for the header of a wave."
    :group 'erc)
  
  
  (defun erc-track-find-face (faces)
    "Just return a reasonable face"
    'erc-modeline)
#+end_src
* Prettiness
#+srcname: ahyatt-pretiness
#+begin_src emacs-lisp
  (require 'zenburn)
  (zenburn)
  
  ;; fixes to zenburn
  
  ;; We should make these things just apply when loaded...
  (require 'jabber-activity)
  (require 'jabber-chat)
  (require 'which-func)
  (require 'gnus)
  (set-face-attribute 'gnus-group-mail-3 nil :foreground "lightblue" :weight 'bold)
  ;; A hack, erc-track-find-face always seems to pick this one, it
  ;; should pick something else, I think.
  (set-face-attribute 'erc-nick-default-face nil :foreground "pink")
  (set-face-attribute 'jabber-activity-personal-face nil :foreground "lightblue")
  (set-face-attribute 'jabber-rare-time-face nil :foreground "dark grey")
  (set-face-attribute 'which-func nil :foreground "white")
  (set-face-attribute 'default nil :family "Inconsolata" :height 180)
  (set-face-attribute 'mode-line nil :family "DejaVu Sans" :width 'condensed :height 0.9 :weight 'extra-light)  

  (defun ash-new-frame (frame)
    (select-frame frame)
    (set-terminal-coding-system 'utf-8)
    (tool-bar-mode -1)
  
    (scroll-bar-mode -1))
  
  ;;; This is how we can get utf8 on terminals with emacsclient
  (add-to-list 'after-make-frame-functions 'ash-new-frame)
  
  ;; useful parenthesis highlight
  (require 'highlight-parentheses)
  (add-hook 'emacs-lisp-mode-hook 'highlight-parentheses-mode)
#+end_src
